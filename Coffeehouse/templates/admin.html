<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Coffee House</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        .admin-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .admin-title {
            color: #6a1b9a;
        }

        .img-preview {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 10px;
        }

        .error-message {
            color: #dc3545;
            margin-top: 5px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">Coffee House Admin</a>
            <div class="ms-auto">
                <a href="/logout" class="btn btn-outline-light">Logout</a>
            </div>
        </div>
    </nav>
    <div class="container py-5">
        <h1 class="mb-4 admin-title">Admin Panel</h1>
        <div id="errorAlert" class="alert alert-danger d-none" role="alert"></div>
        <div id="successAlert" class="alert alert-success d-none" role="alert">
            Content updated successfully! Page will reload in 3 seconds...
        </div>

        <form id="adminForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">





            <div class="admin-section">
                <h3>Hero Section</h3>
                <div class="mb-3">
                    <label>Hero Image</label><br>
                    <img id="heroPreview"
                        src="/static/img/{{ content.hero.image if content.hero.image else 'hero.jpg' }}"
                        class="hero-preview" alt="Hero Image"
                        data-filename="{{ content.hero.image if content.hero.image else 'hero.jpg' }}">
                    <input type="file" id="heroUpload" class="form-control mb-2" accept="image/*">
                    <button type="button" class="btn btn-danger btn-sm" id="removeHero">Remove Hero Image</button>
                </div>
                <div class="mb-3">
                    <label>Hero Title</label>
                    <input type="text" class="form-control" name="hero_title" value="{{ content.hero.title }}" required>
                    <div class="invalid-feedback">Please enter a hero title.</div>
                </div>
                <div class="mb-3">
                    <label>Hero Subtitle</label>
                    <input type="text" class="form-control" name="hero_subtitle" value="{{ content.hero.subtitle }}"
                        required>
                    <div class="invalid-feedback">Please enter a hero subtitle.</div>
                </div>
                <div class="mb-3">
                    <label>Button Text</label>
                    <input type="text" class="form-control" name="hero_button_text"
                        value="{{ content.hero.button_text }}" required>
                    <div class="invalid-feedback">Please enter button text.</div>
                </div>
            </div>




            <div class="admin-section">
                <h3>About</h3>
                <div class="mb-3">
                    <label>Who We Are</label>
                    <textarea class="form-control" name="about_who" rows="2" required>{{ content.about.who }}</textarea>
                    <div class="invalid-feedback">Please enter who we are.</div>
                </div>
                <div class="mb-3">
                    <label>Why Choose Us?</label>
                    <textarea class="form-control" name="about_why" rows="2" required>{{ content.about.why }}</textarea>
                    <div class="invalid-feedback">Please enter why choose us.</div>
                </div>
            </div>


            <div class="admin-section">
                <h3>Menu</h3>
                <div id="menuItems">
                    {% for drink in content.menu %}
                    <div class="row align-items-center mb-3 menu-item-row">
                        <div class="col-md-2">
                            <img src="/static/img/{{ drink.image }}" class="img-preview" alt="{{ drink.name }}"
                                data-filename="{{ drink.image }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control" name="menu_name" value="{{ drink.name }}"
                                placeholder="Name" required>
                            <div class="invalid-feedback">Please enter a drink name.</div>
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control" name="menu_desc" value="{{ drink.description }}"
                                placeholder="Description" required>
                            <div class="invalid-feedback">Please enter a description.</div>
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control" name="menu_price" value="{{ drink.price }}"
                                placeholder="Price" required>
                            <div class="invalid-feedback">Please enter a price.</div>
                        </div>
                        <div class="col-md-2">
                            <input type="file" class="form-control menu-image-upload" accept="image/*">
                            <button type="button" class="btn btn-outline-danger btn-sm mt-1 remove-image">Remove
                                Image</button>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger btn-sm remove-menu">Remove</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-success btn-sm" id="addMenu">Add Drink</button>
            </div>

            <div class="admin-section">
                <h3>Team</h3>
                <div id="teamMembers">
                    {% for member in content.team %}
                    <div class="row align-items-center mb-3 team-member-row">
                        <div class="col-md-2">
                            <img src="/{{ member.image }}" class="img-preview" alt="{{ member.name }}"
                                data-filename="{{ member.image }}">
                        </div>
                        <div class="col-md-2">
                            <input type="text" class="form-control" name="team_name" value="{{ member.name }}"
                                placeholder="Name" required>
                            <div class="invalid-feedback">Please enter a team member name.</div>
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" name="team_bio" value="{{ member.bio }}"
                                placeholder="Bio" required>
                            <div class="invalid-feedback">Please enter a bio.</div>
                        </div>
                        <div class="col-md-1">
                            <input type="file" class="form-control team-image-upload" accept="image/*">
                            <button type="button" class="btn btn-outline-danger btn-sm mt-1 remove-image">Remove
                                Image</button>
                        </div>
                        <div class="col-md-1">
                            <button type="button" class="btn btn-danger btn-sm remove-team">Remove</button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-success btn-sm" id="addTeam">Add Team Member</button>
            </div>

            <div class="admin-section">
                <h3>Branding</h3>
                <div class="mb-3">
                    <label>Logo</label><br>
                    <img id="logoPreview" src="/static/img/{{ content.logo if content.logo else 'logo.png' }}"
                        class="img-preview mb-2" alt="Logo"
                        data-filename="{{ content.logo if content.logo else 'logo.png' }}">
                    <input type="file" id="logoUpload" class="form-control mb-2" accept="image/*">
                    <button type="button" class="btn btn-danger btn-sm" id="removeLogo">Remove Logo</button>
                </div>
                <div class="mb-3">
                    <label>Favicon</label><br>
                    <img id="faviconPreview"
                        src="/static/img/{{ content.favicon if content.favicon else 'favicon.ico' }}"
                        class="img-preview mb-2" alt="Favicon"
                        data-filename="{{ content.favicon if content.favicon else 'favicon.ico' }}">
                    <input type="file" id="faviconUpload" class="form-control mb-2" accept="image/*">
                    <button type="button" class="btn btn-danger btn-sm" id="removeFavicon">Remove Favicon</button>
                </div>
            </div>


            <div class="admin-section">
                <h3>Contact & Map</h3>
                <div class="mb-3">
                    <label>Address</label>
                    <input type="text" class="form-control" name="contact_address" value="{{ content.contact.address }}"
                        required>
                    <div class="invalid-feedback">Please enter an address.</div>
                </div>
                <div class="mb-3">
                    <label>Email</label>
                    <input type="email" class="form-control" name="contact_email" value="{{ content.contact.email }}"
                        required>
                    <div class="invalid-feedback">Please enter a valid email address.</div>
                </div>
                <div class="mb-3">
                    <label>Phone</label>
                    <input type="text" class="form-control" name="contact_phone" value="{{ content.contact.phone }}"
                        required>
                    <div class="invalid-feedback">Please enter a phone number.</div>
                </div>
                <div class="mb-3">
                    <label>Map Provider</label>
                    <select class="form-select" name="map_provider" id="mapProviderSelect">
                        <option value="google" {% if content.contact.map_provider=='google' %}selected{% endif %}>Google
                            Maps</option>
                        <option value="openstreet" {% if content.contact.map_provider=='openstreet' %}selected{% endif
                            %}>OpenStreetMap</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label>Map Location (address or lat,lng)</label>
                    <input type="text" class="form-control" name="map_location"
                        value="{{ content.contact.map_location }}" required>
                    <div class="invalid-feedback">Please enter a map location.</div>
                </div>
                <div class="mb-3">
                    <label>Latitude</label>
                    <input type="text" class="form-control" name="map_lat" id="mapLat"
                        value="{{ content.contact.map_lat|default('') }}" placeholder="Latitude">
                </div>
                <div class="mb-3">
                    <label>Longitude</label>
                    <input type="text" class="form-control" name="map_lng" id="mapLng"
                        value="{{ content.contact.map_lng|default('') }}" placeholder="Longitude">
                </div>
                <div class="mb-3" id="googleApiKeyGroup"
                    style="display: {% if content.contact.map_provider == 'google' %}block{% else %}none{% endif %};">
                    <label>Google Maps API Key (optional, for admin map picker)</label>
                    <input type="text" class="form-control" name="google_maps_api_key" id="googleMapsApiKey"
                        value="{{ content.contact.google_maps_api_key|default('') }}"
                        placeholder="Enter Google Maps API Key">
                </div>
                <div class="mb-3">
                    <label>Pick Location on Map</label>
                    <div id="adminMapPicker" style="height: 250px; border-radius: 10px; overflow: hidden;"></div>
                </div>
            </div>

            <div class="admin-section">
                <h3>Footer Details</h3>
                <div id="footerHours">
                    <label>Hours</label>
                    {% for hour in content.footer.hours %}
                    <div class="row mb-2 footer-hour-row">
                        <div class="col-5"><input type="text" class="form-control" name="footer_days"
                                value="{{ hour.days }}" placeholder="Days"></div>
                        <div class="col-5"><input type="text" class="form-control" name="footer_time"
                                value="{{ hour.time }}" placeholder="Time"></div>
                        <div class="col-2"><button type="button"
                                class="btn btn-danger btn-sm remove-footer-hour">Remove</button></div>
                    </div>
                    {% endfor %}
                </div>
                <button type="button" class="btn btn-success btn-sm mb-3" id="addFooterHour">Add Hours</button>
                <div class="mb-3">
                    <label>Footer Address</label>
                    <input type="text" class="form-control" name="footer_address" value="{{ content.footer.address }}"
                        required>
                    <div class="invalid-feedback">Please enter a footer address.</div>
                </div>
                <div class="mb-3">
                    <label>Footer City</label>
                    <input type="text" class="form-control" name="footer_city" value="{{ content.footer.city }}"
                        required>
                    <div class="invalid-feedback">Please enter a city.</div>
                </div>
                <div class="mb-3">
                    <label>Footer Phone</label>
                    <input type="text" class="form-control" name="footer_phone" value="{{ content.footer.phone }}"
                        required>
                    <div class="invalid-feedback">Please enter a phone number.</div>
                </div>
                <div class="mb-3">
                    <label>Footer Email</label>
                    <input type="email" class="form-control" name="footer_email" value="{{ content.footer.email }}"
                        required>
                    <div class="invalid-feedback">Please enter a valid email address.</div>
                </div>
            </div>

            <button type="submit" class="btn btn-primary" id="submitBtn">
                <span id="submitText">Save Changes</span>
                <span id="submitSpinner" class="spinner-border spinner-border-sm d-none" role="status"
                    aria-hidden="true"></span>
            </button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>

        document.getElementById('addMenu').addEventListener('click', function () {
            const row = document.createElement('div');
            row.className = 'row align-items-center mb-3 menu-item-row';
            row.innerHTML = `
            <div class="col-md-2"><img src="" class="img-preview" alt="" data-filename=""></div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="menu_name" placeholder="Name" required>
                <div class="invalid-feedback">Please enter a drink name.</div>
            </div>
            <div class="col-md-3">
                <input type="text" class="form-control" name="menu_desc" placeholder="Description" required>
                <div class="invalid-feedback">Please enter a description.</div>
            </div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="menu_price" placeholder="Price" required>
                <div class="invalid-feedback">Please enter a price.</div>
            </div>
            <div class="col-md-2">
                <input type="file" class="form-control menu-image-upload" accept="image/*">
                <button type="button" class="btn btn-outline-danger btn-sm mt-1 remove-image">Remove Image</button>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger btn-sm remove-menu">Remove</button>
            </div>
        `;
            document.getElementById('menuItems').appendChild(row);
        });

        document.getElementById('menuItems').addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-menu')) {
                e.target.closest('.menu-item-row').remove();
            }
        });

        document.getElementById('addTeam').addEventListener('click', function () {
            const row = document.createElement('div');
            row.className = 'row align-items-center mb-3 team-member-row';
            row.innerHTML = `
            <div class="col-md-2"><img src="" class="img-preview" alt="" data-filename=""></div>
            <div class="col-md-2">
                <input type="text" class="form-control" name="team_name" placeholder="Name" required>
                <div class="invalid-feedback">Please enter a team member name.</div>
            </div>
            <div class="col-md-6">
                <input type="text" class="form-control" name="team_bio" placeholder="Bio" required>
                <div class="invalid-feedback">Please enter a bio.</div>
            </div>
            <div class="col-md-1">
                <input type="file" class="form-control team-image-upload" accept="image/*">
                <button type="button" class="btn btn-outline-danger btn-sm mt-1 remove-image">Remove Image</button>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger btn-sm remove-team">Remove</button>
            </div>
        `;
            document.getElementById('teamMembers').appendChild(row);
        });

        document.getElementById('teamMembers').addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-team')) {
                e.target.closest('.team-member-row').remove();
            }
        });

        document.getElementById('addFooterHour').addEventListener('click', function () {
            const row = document.createElement('div');
            row.className = 'row mb-2 footer-hour-row';
            row.innerHTML = `
            <div class="col-5"><input type="text" class="form-control" name="footer_days" placeholder="Days"></div>
            <div class="col-5"><input type="text" class="form-control" name="footer_time" placeholder="Time"></div>
            <div class="col-2"><button type="button" class="btn btn-danger btn-sm remove-footer-hour">Remove</button></div>
        `;
            document.getElementById('footerHours').appendChild(row);
        });

        document.getElementById('footerHours').addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-footer-hour')) {
                e.target.closest('.footer-hour-row').remove();
            }
        });

        document.getElementById('adminForm').addEventListener('submit', async function (e) {
            e.preventDefault();

            document.getElementById('errorAlert').classList.add('d-none');
            document.getElementById('successAlert').classList.add('d-none');


            const form = e.target;
            if (!form.checkValidity()) {
                form.classList.add('was-validated');
                return;
            }


            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            submitBtn.disabled = true;
            submitText.textContent = 'Saving...';
            submitSpinner.classList.remove('d-none');

            try {
 
                const data = {

                    hero: {
                        image: document.getElementById('heroPreview').getAttribute('data-filename'),
                        title: form.hero_title.value,
                        subtitle: form.hero_subtitle.value,
                        button_text: form.hero_button_text.value,
                    },

                    about: {
                        who: form.about_who.value,
                        why: form.about_why.value
                    },
                    menu: [],
                    team: [],
                    contact: {
                        address: form.contact_address.value,
                        email: form.contact_email.value,
                        phone: form.contact_phone.value,
                        map_provider: form.map_provider.value,
                        map_location: form.map_location.value,
                        map_lat: form.map_lat.value,
                        map_lng: form.map_lng.value,
                        google_maps_api_key: form.google_maps_api_key ? form.google_maps_api_key.value : ''
                    },
                    footer: {
                        hours: [],
                        address: form.footer_address.value,
                        city: form.footer_city.value,
                        phone: form.footer_phone.value,
                        email: form.footer_email.value
                    }
                };

                document.querySelectorAll('.menu-item-row').forEach(row => {
                    const name = row.querySelector('input[name="menu_name"]').value;
                    const desc = row.querySelector('input[name="menu_desc"]').value;
                    const price = row.querySelector('input[name="menu_price"]').value;
                    const imgTag = row.querySelector('img.img-preview');
                    const image = imgTag.getAttribute('data-filename') || imgTag.src.split('/').pop();

                    if (name && desc && price) {
                        data.menu.push({
                            name,
                            description: desc,
                            price,
                            image: image || 'default-drink.jpg'
                        });
                    }
                });

                document.querySelectorAll('.team-member-row').forEach(row => {
                    const name = row.querySelector('input[name="team_name"]').value;
                    const bio = row.querySelector('input[name="team_bio"]').value;
                    const imgTag = row.querySelector('img.img-preview');
                    const image = imgTag.getAttribute('data-filename') || imgTag.src.replace(/^\//, '');

                    if (name && bio) {
                        data.team.push({
                            name,
                            bio,
                            image: image || 'default-team.jpg'
                        });
                    }
                });

                document.querySelectorAll('.footer-hour-row').forEach(row => {
                    const days = row.querySelector('input[name="footer_days"]').value;
                    const time = row.querySelector('input[name="footer_time"]').value;
                    if (days && time) {
                        data.footer.hours.push({ days, time });
                    }
                });

                const res = await fetch('/api/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                    },
                    body: JSON.stringify(data)
                });

                const responseData = await res.json();

                if (!res.ok) {
                    throw new Error(responseData.error || 'Failed to update content');
                }

                document.getElementById('successAlert').classList.remove('d-none');

                setTimeout(() => {
                    location.reload();
                }, 3000);

            } catch (error) {
                console.error('Error:', error);


                const errorAlert = document.getElementById('errorAlert');
                errorAlert.textContent = error.message;
                errorAlert.classList.remove('d-none');


                errorAlert.scrollIntoView({ behavior: 'smooth' });

            } finally {
                submitBtn.disabled = false;
                submitText.textContent = 'Save Changes';
                submitSpinner.classList.add('d-none');
            }
        });

        document.querySelectorAll('.menu-image-upload, .team-image-upload').forEach(input => {
            input.addEventListener('change', async function () {
                const file = this.files[0];
                if (!file) return;

                const formData = new FormData();
                formData.append('image', file);

                try {
                    const res = await fetch('/api/upload_image', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                        },
                        body: formData
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        throw new Error(data.error || 'Image upload failed');
                    }

                    const imgTag = this.closest('.row').querySelector('img.img-preview');
                    imgTag.src = '/static/img/' + data.filename;
                    imgTag.setAttribute('data-filename', data.filename);

                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message);
                }
            });
        });



        document.getElementById('heroUpload').addEventListener('change', async function () {
            const file = this.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('hero', file);

            try {
                const res = await fetch('/api/upload_hero', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                    },
                    body: formData
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Hero image upload failed');
                }

                const imgTag = document.getElementById('heroPreview');
                imgTag.src = '/static/img/' + data.filename;
                imgTag.setAttribute('data-filename', data.filename);

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });


        document.getElementById('removeHero').addEventListener('click', async function () {
            const imgTag = document.getElementById('heroPreview');
            const filename = imgTag.getAttribute('data-filename');

            if (!filename || filename === 'hero.jpg') {
                return;
            }

            if (!confirm('Remove hero image?')) return;

            try {
                const res = await fetch('/api/delete_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                    },
                    body: JSON.stringify({ filename })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to remove hero image');
                }

                imgTag.src = '/static/img/hero.jpg';
                imgTag.setAttribute('data-filename', 'hero.jpg');

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });



        document.querySelectorAll('.remove-image').forEach(btn => {
            btn.addEventListener('click', async function () {
                const imgTag = this.closest('.row').querySelector('img.img-preview');
                const filename = imgTag.getAttribute('data-filename') || imgTag.src.split('/').pop();

                if (!filename || filename === 'default-drink.jpg' || filename === 'default-team.jpg') {
                    return;
                }

                if (!confirm('Delete this image?')) return;

                try {
                    const res = await fetch('/api/delete_image', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                        },
                        body: JSON.stringify({ filename })
                    });

                    const data = await res.json();

                    if (!res.ok) {
                        throw new Error(data.error || 'Failed to delete image');
                    }

                    imgTag.src = '';
                    imgTag.setAttribute('data-filename', '');

                } catch (error) {
                    console.error('Error:', error);
                    alert(error.message);
                }
            });
        });

        document.getElementById('logoUpload').addEventListener('change', async function () {
            const file = this.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('logo', file);

            try {
                const res = await fetch('/api/upload_logo', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                    },
                    body: formData
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Logo upload failed');
                }

                const imgTag = document.getElementById('logoPreview');
                imgTag.src = '/static/img/' + data.filename;
                imgTag.setAttribute('data-filename', data.filename);

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });

        document.getElementById('faviconUpload').addEventListener('change', async function () {
            const file = this.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('favicon', file);

            try {
                const res = await fetch('/api/upload_favicon', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                    },
                    body: formData
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Favicon upload failed');
                }

                const imgTag = document.getElementById('faviconPreview');
                imgTag.src = '/static/img/' + data.filename;
                imgTag.setAttribute('data-filename', data.filename);

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });


        document.getElementById('removeLogo').addEventListener('click', async function () {
            const imgTag = document.getElementById('logoPreview');
            const filename = imgTag.getAttribute('data-filename');

            if (!filename || filename === 'logo.png') {
                return;
            }

            if (!confirm('Remove logo?')) return;

            try {
                const res = await fetch('/api/delete_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                    },
                    body: JSON.stringify({ filename })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to remove logo');
                }

                imgTag.src = '/static/img/logo.png';
                imgTag.setAttribute('data-filename', 'logo.png');

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });

  
        document.getElementById('removeFavicon').addEventListener('click', async function () {
            const imgTag = document.getElementById('faviconPreview');
            const filename = imgTag.getAttribute('data-filename');

            if (!filename || filename === 'favicon.ico') {
                return;
            }

            if (!confirm('Remove favicon?')) return;

            try {
                const res = await fetch('/api/delete_image', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
                    },
                    body: JSON.stringify({ filename })
                });

                const data = await res.json();

                if (!res.ok) {
                    throw new Error(data.error || 'Failed to remove favicon');
                }

                imgTag.src = '/static/img/favicon.ico';
                imgTag.setAttribute('data-filename', 'favicon.ico');

            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        });


        function initMapPicker() {
            const provider = document.getElementById('mapProviderSelect').value;
            const latInput = document.getElementById('mapLat');
            const lngInput = document.getElementById('mapLng');
            const apiKey = document.getElementById('googleMapsApiKey')?.value.trim() || '';
            let lat = parseFloat(latInput.value) || 40.7128;
            let lng = parseFloat(lngInput.value) || -74.0060;

            if (window.adminMap) {
                window.adminMap.remove();
                window.adminMap = null;
            }

            if (provider === 'google' && apiKey) {
                if (!window.google || !window.google.maps) {
                    const script = document.createElement('script');
                    script.src = 'https://maps.googleapis.com/maps/api/js?key=' + encodeURIComponent(apiKey) + '&loading=async&callback=initMapPicker';
                    script.async = true;
                    document.body.appendChild(script);
                    return;
                }

                window.adminMap = new google.maps.Map(document.getElementById('adminMapPicker'), {
                    center: { lat: lat, lng: lng },
                    zoom: 13
                });

                let marker = new google.maps.Marker({
                    position: { lat: lat, lng: lng },
                    map: window.adminMap,
                    draggable: true
                });

                marker.addListener('dragend', function (e) {
                    latInput.value = e.latLng.lat().toFixed(6);
                    lngInput.value = e.latLng.lng().toFixed(6);
                });

                window.adminMap.addListener('click', function (e) {
                    marker.setPosition(e.latLng);
                    latInput.value = e.latLng.lat().toFixed(6);
                    lngInput.value = e.latLng.lng().toFixed(6);
                });

            } else {
                if (window.L === undefined) {
                    const leafletCSS = document.createElement('link');
                    leafletCSS.rel = 'stylesheet';
                    leafletCSS.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
                    document.head.appendChild(leafletCSS);

                    const leafletJS = document.createElement('script');
                    leafletJS.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
                    leafletJS.onload = initMapPicker;
                    document.body.appendChild(leafletJS);
                    return;
                }

                window.adminMap = L.map('adminMapPicker').setView([lat, lng], 13);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                }).addTo(window.adminMap);

                let marker = L.marker([lat, lng], { draggable: true }).addTo(window.adminMap);

                marker.on('dragend', function (e) {
                    const pos = marker.getLatLng();
                    latInput.value = pos.lat.toFixed(6);
                    lngInput.value = pos.lng.toFixed(6);
                });

                window.adminMap.on('click', function (e) {
                    marker.setLatLng(e.latlng);
                    latInput.value = e.latlng.lat.toFixed(6);
                    lngInput.value = e.latlng.lng.toFixed(6);
                });
            }
        }

        document.getElementById('mapProviderSelect').addEventListener('change', function () {
            document.getElementById('googleApiKeyGroup').style.display = this.value === 'google' ? 'block' : 'none';
            setTimeout(initMapPicker, 100);
        });

        if (document.getElementById('googleMapsApiKey')) {
            document.getElementById('googleMapsApiKey').addEventListener('input', function () {
                setTimeout(initMapPicker, 100);
            });
        }

        window.addEventListener('DOMContentLoaded', function () {
            initMapPicker();
        });
    </script>
</body>

</html>